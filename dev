#!/bin/bash

# Hygieia Development Script
set -e

case "$1" in
  "start")
    echo "ðŸš€ Starting Hygieia Health Aggregator..."
    echo ""
    
    # Install backend dependencies
    echo "ðŸ“¦ Installing backend dependencies..."
    cd backend
    poetry install --quiet
    cd ..
    
    # Install frontend dependencies
    echo "ðŸ“¦ Installing frontend dependencies..."
    cd frontend
    npm install --silent
    cd ..
    
    echo ""
    echo "âœ… Dependencies installed!"
    echo ""
    echo "ðŸ”¥ Starting services..."
    echo ""
    
    # Start backend in background
    echo "ðŸ Starting Python backend on http://localhost:8000"
    cd backend
    poetry run uvicorn main:app --reload --host 0.0.0.0 --port 8000 &
    BACKEND_PID=$!
    cd ..
    
    # Wait a moment for backend to start
    sleep 2
    
    # Start frontend in background
    echo "âš›ï¸  Starting Next.js frontend on http://localhost:3000"
    cd frontend
    npm run dev &
    FRONTEND_PID=$!
    cd ..
    
    echo ""
    echo "ðŸŽ‰ Hygieia is running!"
    echo ""
    echo "ðŸ“Š Health Dashboard: http://localhost:3000"
    echo "ðŸ”§ API Documentation: http://localhost:8000/docs"
    echo ""
    echo "Press Ctrl+C to stop all services"
    
    # Function to cleanup processes
    cleanup() {
      echo ""
      echo "ðŸ›‘ Stopping services..."
      kill $BACKEND_PID 2>/dev/null || true
      kill $FRONTEND_PID 2>/dev/null || true
      echo "âœ… All services stopped"
      exit 0
    }
    
    # Trap Ctrl+C
    trap cleanup SIGINT
    
    # Wait for processes
    wait
    ;;
    
  "stop")
    echo "ðŸ›‘ Stopping Hygieia services..."
    pkill -f "uvicorn main:app" || true
    pkill -f "next dev" || true
    echo "âœ… Services stopped"
    ;;
    
  *)
    echo "Hygieia Development Script"
    echo ""
    echo "Usage:"
    echo "  ./dev start    Start backend and frontend"
    echo "  ./dev stop     Stop all services"
    echo ""
    echo "URLs:"
    echo "  http://localhost:3000  - Health Dashboard"
    echo "  http://localhost:8000  - API Documentation"
    ;;
esac